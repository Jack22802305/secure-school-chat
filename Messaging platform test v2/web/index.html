<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Clone</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="webrtc.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .discord-bg { background-color: #36393f; }
        .discord-sidebar { background-color: #2f3136; }
        .discord-channel-list { background-color: #2f3136; }
        .discord-chat { background-color: #36393f; }
        .discord-message { background-color: #40444b; }
        .discord-input { background-color: #40444b; }
        .discord-server { background-color: #5865f2; }
        .discord-text { color: #dcddde; }
        .discord-muted { color: #8e9297; }
        .discord-online { color: #3ba55d; }
        .discord-hover:hover { background-color: #34373c; }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #2f3136;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #202225;
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #1a1c1f;
        }
    </style>
</head>
<body class="discord-bg">
    <div id="app"></div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, onUnmounted } = Vue;

        const App = {
            setup() {
                // State
                const user = ref(null);
                const servers = ref([]);
                const currentServer = ref(null);
                const currentChannel = ref(null);
                const channels = ref([]);
                const messages = ref([]);
                const onlineUsers = ref([]);
                const messageInput = ref('');
                const showLogin = ref(true);
                const loginForm = reactive({
                    username: '',
                    email: '',
                    password: '',
                    isRegister: false
                });

                // WebSocket connection
                let socket = null;
                let p2pClient = null;
                let webrtcClient = null;
                
                // Voice/Video state
                const inVoiceChannel = ref(false);
                const isMuted = ref(false);
                const isVideoDisabled = ref(true);
                const isScreenSharing = ref(false);
                const voiceUsers = ref([]);
                const localVideoRef = ref(null);
                const remoteVideos = ref(new Map());

                // API calls
                const api = {
                    async post(url, data) {
                        const response = await fetch(`/api${url}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': user.value?.id || ''
                            },
                            body: JSON.stringify(data)
                        });
                        return response.json();
                    },
                    
                    async get(url) {
                        const response = await fetch(`/api${url}`, {
                            headers: {
                                'Authorization': user.value?.id || ''
                            }
                        });
                        return response.json();
                    }
                };

                // Authentication
                const login = async () => {
                    try {
                        const endpoint = loginForm.isRegister ? '/auth/register' : '/auth/login';
                        const result = await api.post(endpoint, loginForm);
                        
                        if (result.success) {
                            user.value = result.user;
                            showLogin.value = false;
                            await loadServers();
                            connectWebSocket();
                        } else {
                            alert(result.message || 'Authentication failed');
                        }
                    } catch (error) {
                        console.error('Auth error:', error);
                        alert('Authentication failed');
                    }
                };

                const logout = () => {
                    user.value = null;
                    showLogin.value = true;
                    if (socket) {
                        socket.close();
                    }
                };

                // WebSocket connection
                const connectWebSocket = () => {
                    // Use native WebSocket instead of Socket.IO for simplicity
                    const wsUrl = `ws://localhost:8080/api/ws?user_id=${user.value.id}`;
                    socket = new WebSocket(wsUrl);
                    
                    socket.onopen = () => {
                        console.log('WebSocket connected');
                    };
                    
                    socket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('WebSocket message:', data);
                            
                            switch (data.type) {
                                case 'new_message':
                                    if (data.data.channel_id === currentChannel.value?.id) {
                                        messages.value.push(data.data);
                                        scrollToBottom();
                                    }
                                    break;
                                case 'user_joined':
                                    console.log('User joined:', data.data.user_id);
                                    loadOnlineUsers();
                                    break;
                                case 'user_left':
                                    console.log('User left:', data.data.user_id);
                                    loadOnlineUsers();
                                    break;
                            }
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };
                    
                    socket.onclose = () => {
                        console.log('WebSocket disconnected');
                    };
                    
                    socket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                };

                // Online users management
                const loadOnlineUsers = async () => {
                    try {
                        onlineUsers.value = await api.get('/online-users');
                    } catch (error) {
                        console.error('Failed to load online users:', error);
                    }
                };

                // Server management
                const loadServers = async () => {
                    try {
                        servers.value = await api.get('/servers');
                        if (servers.value.length > 0) {
                            selectServer(servers.value[0]);
                        }
                        // Load online users when servers are loaded
                        await loadOnlineUsers();
                    } catch (error) {
                        console.error('Failed to load servers:', error);
                    }
                };

                const createServer = async () => {
                    const name = prompt('Server name:');
                    if (!name) return;
                    
                    try {
                        const server = await api.post('/servers', { 
                            name,
                            description: `${name} server` 
                        });
                        servers.value.push(server);
                        selectServer(server);
                        console.log('Server created:', server);
                    } catch (error) {
                        console.error('Failed to create server:', error);
                        alert('Failed to create server: ' + error.message);
                    }
                };

                const selectServer = async (server) => {
                    currentServer.value = server;
                    await loadChannels(server.id);
                };

                // Channel management
                const loadChannels = async (serverId) => {
                    try {
                        channels.value = await api.get(`/servers/${serverId}/channels`);
                        if (channels.value.length > 0) {
                            selectChannel(channels.value[0]);
                        }
                    } catch (error) {
                        console.error('Failed to load channels:', error);
                    }
                };

                const createChannel = async () => {
                    if (!currentServer.value) return;
                    
                    const name = prompt('Channel name:');
                    if (!name) return;
                    
                    const type = confirm('Voice channel? (OK = Voice, Cancel = Text)') ? 'voice' : 'text';
                    
                    try {
                        const channel = await api.post(`/servers/${currentServer.value.id}/channels`, {
                            name,
                            type
                        });
                        channels.value.push(channel);
                        console.log('Channel created:', channel);
                    } catch (error) {
                        console.error('Failed to create channel:', error);
                        alert('Failed to create channel: ' + error.message);
                    }
                };

                const selectChannel = async (channel) => {
                    currentChannel.value = channel;
                    await loadMessages(channel.id);
                    
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: 'join_channel',
                            data: { channel_id: channel.id }
                        }));
                    }
                };

                // Message management
                const loadMessages = async (channelId) => {
                    try {
                        messages.value = await api.get(`/channels/${channelId}/messages`);
                        scrollToBottom();
                    } catch (error) {
                        console.error('Failed to load messages:', error);
                    }
                };

                const sendMessage = async () => {
                    if (!messageInput.value.trim() || !currentChannel.value) return;
                    
                    try {
                        await api.post(`/channels/${currentChannel.value.id}/messages`, {
                            content: messageInput.value,
                            type: 'text'
                        });
                        messageInput.value = '';
                    } catch (error) {
                        console.error('Failed to send message:', error);
                    }
                };

                const scrollToBottom = () => {
                    setTimeout(() => {
                        const chatContainer = document.getElementById('chat-messages');
                        if (chatContainer) {
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    }, 100);
                };

                // Voice/Video calls (simplified for now)
                const startVoiceCall = async () => {
                    if (!currentChannel.value || currentChannel.value.type !== 'voice') return;
                    
                    try {
                        // Request microphone access
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        inVoiceChannel.value = true;
                        isVideoDisabled.value = true;
                        
                        alert(`Voice call started in ${currentChannel.value.name}! (Simplified version - WebRTC P2P calls will be implemented in full version)`);
                        
                        // Stop the stream for now (in full version, this would be used for WebRTC)
                        stream.getTracks().forEach(track => track.stop());
                        
                    } catch (error) {
                        console.error('Failed to start voice call:', error);
                        alert('Failed to start voice call. Please check your microphone permissions.');
                    }
                };

                const startVideoCall = async () => {
                    if (!currentChannel.value || currentChannel.value.type !== 'voice') return;
                    
                    try {
                        // Request camera and microphone access
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            audio: true, 
                            video: true 
                        });
                        inVoiceChannel.value = true;
                        isVideoDisabled.value = false;
                        
                        alert(`Video call started in ${currentChannel.value.name}! (Simplified version - WebRTC P2P calls will be implemented in full version)`);
                        
                        // Stop the stream for now (in full version, this would be used for WebRTC)
                        stream.getTracks().forEach(track => track.stop());
                        
                    } catch (error) {
                        console.error('Failed to start video call:', error);
                        alert('Failed to start video call. Please check your camera and microphone permissions.');
                    }
                };

                const leaveVoiceCall = () => {
                    inVoiceChannel.value = false;
                    isMuted.value = false;
                    isVideoDisabled.value = true;
                    isScreenSharing.value = false;
                    voiceUsers.value = [];
                    remoteVideos.value.clear();
                    
                    alert('Left voice/video call');
                };

                const toggleMute = async () => {
                    isMuted.value = !isMuted.value;
                    alert(isMuted.value ? 'Muted' : 'Unmuted');
                };

                const toggleVideo = async () => {
                    isVideoDisabled.value = !isVideoDisabled.value;
                    alert(isVideoDisabled.value ? 'Video disabled' : 'Video enabled');
                };

                const shareScreen = async () => {
                    isScreenSharing.value = true;
                    alert('Screen sharing started (simplified version)');
                };

                const stopScreenShare = async () => {
                    isScreenSharing.value = false;
                    alert('Screen sharing stopped');
                };

                // Utility functions
                const formatTime = (timestamp) => {
                    return new Date(timestamp).toLocaleTimeString();
                };

                const getChannelIcon = (type) => {
                    return type === 'voice' ? 'fas fa-volume-up' : 'fas fa-hashtag';
                };

                // Lifecycle
                onMounted(() => {
                    // Auto-login for development
                    if (localStorage.getItem('dev_user')) {
                        const savedUser = JSON.parse(localStorage.getItem('dev_user'));
                        user.value = savedUser;
                        showLogin.value = false;
                        loadServers();
                        connectWebSocket();
                    }
                });

                onUnmounted(() => {
                    if (socket) {
                        socket.disconnect();
                    }
                });

                return {
                    // State
                    user,
                    servers,
                    currentServer,
                    currentChannel,
                    channels,
                    messages,
                    onlineUsers,
                    messageInput,
                    showLogin,
                    loginForm,
                    inVoiceChannel,
                    isMuted,
                    isVideoDisabled,
                    isScreenSharing,
                    voiceUsers,
                    localVideoRef,
                    remoteVideos,
                    
                    // Methods
                    login,
                    logout,
                    loadOnlineUsers,
                    loadServers,
                    createServer,
                    selectServer,
                    loadChannels,
                    createChannel,
                    selectChannel,
                    sendMessage,
                    startVoiceCall,
                    startVideoCall,
                    leaveVoiceCall,
                    toggleMute,
                    toggleVideo,
                    shareScreen,
                    stopScreenShare,
                    formatTime,
                    getChannelIcon
                };
            },

            template: `
                <!-- Login Screen -->
                <div v-if="showLogin" class="min-h-screen flex items-center justify-center">
                    <div class="discord-message p-8 rounded-lg w-96">
                        <h2 class="text-2xl font-bold discord-text mb-6 text-center">
                            {{ loginForm.isRegister ? 'Create Account' : 'Welcome Back' }}
                        </h2>
                        
                        <form @submit.prevent="login" class="space-y-4">
                            <div>
                                <label class="block discord-text text-sm font-medium mb-2">Username</label>
                                <input v-model="loginForm.username" type="text" required
                                       class="w-full p-3 discord-input rounded discord-text">
                            </div>
                            
                            <div v-if="loginForm.isRegister">
                                <label class="block discord-text text-sm font-medium mb-2">Email</label>
                                <input v-model="loginForm.email" type="email" required
                                       class="w-full p-3 discord-input rounded discord-text">
                            </div>
                            
                            <div>
                                <label class="block discord-text text-sm font-medium mb-2">Password</label>
                                <input v-model="loginForm.password" type="password" required
                                       class="w-full p-3 discord-input rounded discord-text">
                            </div>
                            
                            <button type="submit" class="w-full discord-server text-white p-3 rounded font-medium">
                                {{ loginForm.isRegister ? 'Register' : 'Login' }}
                            </button>
                        </form>
                        
                        <p class="discord-muted text-center mt-4">
                            {{ loginForm.isRegister ? 'Already have an account?' : 'Need an account?' }}
                            <button @click="loginForm.isRegister = !loginForm.isRegister" 
                                    class="text-blue-400 hover:underline">
                                {{ loginForm.isRegister ? 'Login' : 'Register' }}
                            </button>
                        </p>
                    </div>
                </div>

                <!-- Main App -->
                <div v-else class="flex h-screen">
                    <!-- Server List -->
                    <div class="w-16 discord-sidebar flex flex-col items-center py-3 space-y-2">
                        <div v-for="server in servers" :key="server.id"
                             @click="selectServer(server)"
                             :class="['w-12 h-12 rounded-full flex items-center justify-center cursor-pointer text-white font-bold', 
                                     currentServer?.id === server.id ? 'discord-server' : 'discord-message discord-hover']">
                            {{ server.name.charAt(0).toUpperCase() }}
                        </div>
                        
                        <button @click="createServer" 
                                class="w-12 h-12 rounded-full discord-message discord-hover flex items-center justify-center text-green-400">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <!-- Channel List -->
                    <div class="w-60 discord-channel-list flex flex-col">
                        <div class="p-4 border-b border-gray-600">
                            <h3 class="discord-text font-bold">{{ currentServer?.name || 'Select Server' }}</h3>
                        </div>
                        
                        <div class="flex-1 p-2 overflow-y-auto scrollbar-thin">
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="discord-muted text-xs font-semibold uppercase">Text Channels</h4>
                                    <button @click="createChannel" class="discord-muted hover:discord-text">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                                
                                <div v-for="channel in channels.filter(c => c.type === 'text')" :key="channel.id"
                                     @click="selectChannel(channel)"
                                     :class="['flex items-center p-2 rounded cursor-pointer', 
                                             currentChannel?.id === channel.id ? 'discord-message' : 'discord-hover']">
                                    <i :class="getChannelIcon(channel.type)" class="discord-muted mr-2"></i>
                                    <span class="discord-text">{{ channel.name }}</span>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="discord-muted text-xs font-semibold uppercase">Voice Channels</h4>
                                </div>
                                
                                <div v-for="channel in channels.filter(c => c.type === 'voice')" :key="channel.id"
                                     @click="selectChannel(channel)"
                                     :class="['flex items-center p-2 rounded cursor-pointer', 
                                             currentChannel?.id === channel.id ? 'discord-message' : 'discord-hover']">
                                    <i :class="getChannelIcon(channel.type)" class="discord-muted mr-2"></i>
                                    <span class="discord-text">{{ channel.name }}</span>
                                    <div class="ml-auto flex space-x-1">
                                        <button v-if="!inVoiceChannel" @click.stop="startVoiceCall" class="discord-muted hover:discord-text">
                                            <i class="fas fa-phone text-xs"></i>
                                        </button>
                                        <button v-if="!inVoiceChannel" @click.stop="startVideoCall" class="discord-muted hover:discord-text">
                                            <i class="fas fa-video text-xs"></i>
                                        </button>
                                        <button v-if="inVoiceChannel && currentChannel?.id === channel.id" @click.stop="leaveVoiceCall" 
                                                class="text-red-400 hover:text-red-300">
                                            <i class="fas fa-phone-slash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Info -->
                        <div class="p-3 border-t border-gray-600">
                            <div class="flex items-center mb-2">
                                <div class="w-8 h-8 rounded-full discord-server flex items-center justify-center text-white text-sm font-bold mr-2">
                                    {{ user?.username?.charAt(0).toUpperCase() }}
                                </div>
                                <div class="flex-1">
                                    <div class="discord-text text-sm font-medium">{{ user?.username }}</div>
                                    <div class="discord-online text-xs">{{ inVoiceChannel ? 'In Voice Channel' : 'Online' }}</div>
                                </div>
                                <button @click="logout" class="discord-muted hover:discord-text">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                            
                            <!-- Voice Controls -->
                            <div v-if="inVoiceChannel" class="flex items-center justify-center space-x-2 mt-2">
                                <button @click="toggleMute" :class="['p-2 rounded', isMuted ? 'bg-red-600 text-white' : 'discord-message discord-hover']">
                                    <i :class="isMuted ? 'fas fa-microphone-slash' : 'fas fa-microphone'" class="text-sm"></i>
                                </button>
                                <button @click="toggleVideo" :class="['p-2 rounded', isVideoDisabled ? 'discord-message discord-hover' : 'bg-green-600 text-white']">
                                    <i :class="isVideoDisabled ? 'fas fa-video-slash' : 'fas fa-video'" class="text-sm"></i>
                                </button>
                                <button @click="isScreenSharing ? stopScreenShare() : shareScreen()" 
                                        :class="['p-2 rounded', isScreenSharing ? 'bg-blue-600 text-white' : 'discord-message discord-hover']">
                                    <i class="fas fa-desktop text-sm"></i>
                                </button>
                                <button @click="leaveVoiceCall" class="p-2 rounded bg-red-600 text-white hover:bg-red-700">
                                    <i class="fas fa-phone-slash text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="flex-1 flex flex-col">
                        <!-- Chat Header -->
                        <div class="p-4 border-b border-gray-600 flex items-center">
                            <i :class="getChannelIcon(currentChannel?.type)" class="discord-muted mr-2"></i>
                            <h3 class="discord-text font-bold">{{ currentChannel?.name || 'Select Channel' }}</h3>
                            <div class="ml-auto flex items-center space-x-3">
                                <button v-if="currentChannel?.type === 'voice' && !inVoiceChannel" @click="startVoiceCall" 
                                        class="discord-muted hover:discord-text">
                                    <i class="fas fa-phone"></i>
                                </button>
                                <button v-if="currentChannel?.type === 'voice' && !inVoiceChannel" @click="startVideoCall" 
                                        class="discord-muted hover:discord-text">
                                    <i class="fas fa-video"></i>
                                </button>
                                <span v-if="inVoiceChannel" class="discord-text text-sm">
                                    {{ voiceUsers.length + 1 }} in call
                                </span>
                            </div>
                        </div>

                        <!-- Video Call Area -->
                        <div v-if="inVoiceChannel && (!isVideoDisabled || voiceUsers.some(u => u.stream?.getVideoTracks().length > 0))" 
                             class="p-4 border-b border-gray-600 discord-message">
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <!-- Local Video -->
                                <div v-if="!isVideoDisabled" class="relative">
                                    <video ref="localVideoRef" autoplay muted class="w-full h-32 bg-black rounded object-cover"></video>
                                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
                                        {{ user?.username }} (You)
                                    </div>
                                    <div v-if="isMuted" class="absolute top-2 right-2 bg-red-600 text-white p-1 rounded">
                                        <i class="fas fa-microphone-slash text-xs"></i>
                                    </div>
                                </div>
                                
                                <!-- Remote Videos -->
                                <div v-for="voiceUser in voiceUsers" :key="voiceUser.id" class="relative">
                                    <video :ref="'remoteVideo_' + voiceUser.id" autoplay class="w-full h-32 bg-black rounded object-cover"></video>
                                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
                                        User {{ voiceUser.id.substring(0, 8) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto scrollbar-thin">
                            <div v-for="message in messages" :key="message.id" class="mb-4 flex">
                                <div class="w-10 h-10 rounded-full discord-server flex items-center justify-center text-white text-sm font-bold mr-3 flex-shrink-0">
                                    {{ message.user?.username?.charAt(0).toUpperCase() || 'U' }}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-baseline mb-1">
                                        <span class="discord-text font-medium mr-2">{{ message.user?.username || 'Unknown' }}</span>
                                        <span class="discord-muted text-xs">{{ formatTime(message.created_at) }}</span>
                                    </div>
                                    <div class="discord-text">{{ message.content }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Message Input -->
                        <div class="p-4">
                            <form @submit.prevent="sendMessage" class="flex">
                                <input v-model="messageInput" 
                                       :placeholder="'Message #' + (currentChannel?.name || 'channel')"
                                       class="flex-1 p-3 discord-input rounded-l discord-text">
                                <button type="submit" class="px-4 discord-server text-white rounded-r">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- User List -->
                    <div class="w-60 discord-sidebar p-4">
                        <h4 class="discord-muted text-xs font-semibold uppercase mb-3">Online — {{ onlineUsers.length }}</h4>
                        <div v-for="onlineUser in onlineUsers" :key="onlineUser.id" class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full discord-server flex items-center justify-center text-white text-sm font-bold mr-2">
                                {{ onlineUser.username.charAt(0).toUpperCase() }}
                            </div>
                            <span class="discord-text text-sm">{{ onlineUser.username }}</span>
                        </div>
                        <div v-if="onlineUsers.length === 0" class="discord-muted text-sm">
                            No users online
                        </div>
                    </div>
                </div>
            `
        };

        createApp(App).mount('#app');
    </script>
</body>
</html>
